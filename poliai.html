<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PoliAI — AI Poultry Farm Monitor</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#071827;
    --card:#071a2a;
    --accent:#ffb86b;
    --accent2:#ff8fab;
    --ok:#7ee7a6;
    --warn:#ffd166;
    --danger:#ff6b6b;
    --muted:#9fb3c8;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial;
    background: linear-gradient(180deg,#03101a 0%, #071827 100%);
    color:#e6eef6;
    padding:28px;
  }
  .wrap{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 380px;gap:18px;align-items:start}
  header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  h1{margin:0;font-size:20px}
  .sub{color:var(--muted);font-size:13px}

  .card{background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px;padding:14px;box-shadow:0 8px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
  .stage{position:relative;border-radius:10px;overflow:hidden;background:rgba(255,255,255,0.02);height:380px;display:flex;align-items:center;justify-content:center}
  video#cam{width:100%;height:100%;object-fit:cover;background:#031827}
  canvas#overlay{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}

  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:12px}
  button, label.upload{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;color:#041018;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  input[type=file]{display:none}

  .metrics{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
  .metric{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;min-width:140px}
  .metric .value{font-weight:800;font-size:18px}
  .timeline{max-height:300px;overflow:auto;margin-top:12px;padding:8px;display:flex;flex-direction:column;gap:8px}

  .sidebar{display:flex;flex-direction:column;gap:12px}
  .chart-wrap{height:170px}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;background:rgba(255,255,255,0.02)}
  .alert-badge{background:linear-gradient(90deg,var(--danger),#ff8f8f);color:#2b0505}

  footer{grid-column:1/-1;margin-top:12px;color:var(--muted);font-size:13px;text-align:center}
  .small{font-size:13px;color:var(--muted)}
  @media (max-width:980px){ .wrap{grid-template-columns:1fr;padding:18px} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>PoliAI — AI Poultry Farm Monitor</h1>
        <div class="sub">AI-driven poultry monitoring for production optimization, health & environment control</div>
      </div>
      <div>
        <span class="badge">Delstarford</span>
        <span class="badge" id="systemStatus" style="margin-left:8px">System: Mock</span>
      </div>
    </header>

    <!-- Left: Live camera, controls, metrics -->
    <section class="card">
      <div class="stage" id="stage">
        <video id="cam" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
      </div>

      <div class="controls" role="toolbar" aria-label="Controls">
        <button id="startBtn">Start Camera</button>
        <button id="stopBtn" class="secondary">Stop</button>
        <label class="upload">Upload<input id="fileInput" type="file" accept="image/*,video/*"></label>
        <button id="snapshotBtn" class="secondary">Snapshot</button>
        <button id="simulateBtn">Simulate Event</button>
      </div>

      <div class="metrics" aria-live="polite">
        <div class="metric">
          <div class="small">Temperature</div>
          <div class="value" id="tempVal">-- °C</div>
        </div>
        <div class="metric">
          <div class="small">Humidity</div>
          <div class="value" id="humVal">-- %</div>
        </div>
        <div class="metric">
          <div class="small">Ammonia (NH3)</div>
          <div class="value" id="nh3Val">-- ppm</div>
        </div>
        <div class="metric">
          <div class="small">Feed Level</div>
          <div class="value" id="feedVal">-- %</div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
        <div class="small">Detections: <strong id="detCount">0</strong></div>
        <div class="small">Last alert: <span id="lastAlert">—</span></div>
      </div>

      <div class="timeline" id="timeline" role="log" aria-live="polite"></div>
    </section>

    <!-- Right: Charts and controls -->
    <aside class="card sidebar">
      <div>
        <div style="display:flex;justify-content:space-between;align-items:end">
          <div>
            <div style="font-weight:700">Environment Trends</div>
            <div class="small">Recent sensor history</div>
          </div>
          <div style="text-align:right"><div class="small">Production Risk</div><div id="riskScore" style="font-weight:800;font-size:18px;color:var(--accent)">8%</div></div>
        </div>

        <div class="chart-wrap">
          <canvas id="envChart"></canvas>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div>
          <div class="small">Alerts</div>
          <div id="alertState" class="small">None</div>
        </div>
        <div>
          <button id="toggleAudio" class="secondary">Toggle Alerts</button>
        </div>
      </div>

      <div>
        <div style="font-weight:700;margin-bottom:8px">Quick Actions</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="ventilateBtn" class="secondary">Trigger Ventilation</button>
          <button id="feedBtn" class="secondary">Top-Up Feed</button>
          <button id="notifyBtn" class="secondary">Send Notification</button>
        </div>
      </div>
    </aside>

    <footer class="card">PoliAI prototype </footer>
  </div>

<script>
/*
  PoliAI prototype
  - Camera preview via getUserMedia
  - Simulated sensors (temp, humidity, NH3, feed)
  - Simulated detections and alerts (bounding boxes on overlay)
  - Chart.js environment chart
  - Loud audio beep + speech synthesis for alerts
  - Hooks for integrating real telemetry or ML inference
*/

/* Elements */
const video = document.getElementById('cam');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const fileInput = document.getElementById('fileInput');
const snapshotBtn = document.getElementById('snapshotBtn');
const simulateBtn = document.getElementById('simulateBtn');
const tempVal = document.getElementById('tempVal');
const humVal = document.getElementById('humVal');
const nh3Val = document.getElementById('nh3Val');
const feedVal = document.getElementById('feedVal');
const timeline = document.getElementById('timeline');
const detCount = document.getElementById('detCount');
const lastAlert = document.getElementById('lastAlert');
const envChartCtx = document.getElementById('envChart').getContext('2d');
const alertState = document.getElementById('alertState');
const riskScore = document.getElementById('riskScore');
const systemStatus = document.getElementById('systemStatus');

let stream = null;
let simInterval = null;
let alertSoundOn = true;
let history = {temp:[],hum:[],nh3:[],feed:[],t:[]};
let detections = [];

/* Audio & speech */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playBeep(freq = 880, duration=0.22, vol=1.0){
  if (!alertSoundOn) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sine'; o.frequency.value = freq;
  g.gain.value = vol;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  setTimeout(()=> o.stop(), duration*1000);
}
function speak(text){
  try {
    const s = window.speechSynthesis;
    if (!s) return;
    s.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 0.95; u.pitch = 1; u.volume = 1;
    s.speak(u);
  } catch(e){ console.warn(e); }
}

/* Overlay resize */
function resizeOverlay(){
  overlay.width = overlay.clientWidth;
  overlay.height = overlay.clientHeight;
}
window.addEventListener('resize', resizeOverlay);

/* Camera controls */
startBtn.onclick = async () => {
  if (stream) return;
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 }, audio: false });
    video.srcObject = stream;
    await video.play();
    resizeOverlay();
    startSimulation();
    systemStatus.textContent = 'System: Live (Mock)';
  } catch (err) {
    alert('Camera start failed: ' + err.message);
  }
};
stopBtn.onclick = () => {
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
  stopSimulation();
  ctx.clearRect(0,0,overlay.width,overlay.height);
  systemStatus.textContent = 'System: Stopped';
};

/* File upload (image or video) */
fileInput.onchange = (e) => {
  const f = e.target.files[0]; if (!f) return;
  const url = URL.createObjectURL(f);
  video.srcObject = null;
  video.pause();
  video.removeAttribute('src');
  video.src = url;
  video.play();
  resizeOverlay();
};

/* Snapshot */
snapshotBtn.onclick = () => {
  const tmp = document.createElement('canvas'); tmp.width = overlay.width; tmp.height = overlay.height;
  const tctx = tmp.getContext('2d');
  try { tctx.drawImage(video, 0,0, tmp.width, tmp.height); tctx.drawImage(overlay,0,0,tmp.width,tmp.height); } catch(e){}
  const a = document.createElement('a'); a.href = tmp.toDataURL('image/png'); a.download = 'poliai_snapshot.png'; a.click();
};

/* Timeline helper */
function pushEvent(title, meta){
  const el = document.createElement('div'); el.style.display='flex'; el.style.gap='8px'; el.style.alignItems='flex-start';
  const time = new Date().toLocaleTimeString();
  el.innerHTML = `<div style="min-width:70px;color:#9fb3c8">${time}</div><div><div style="font-weight:700">${title}</div><div style="color:#9fb3c8">${meta}</div></div>`;
  timeline.prepend(el);
  if (timeline.children.length > 60) timeline.removeChild(timeline.lastChild);
}

/* Simulated sensors (random walk) */
function seedHistory(){
  const now = Date.now();
  for (let i=0;i<16;i++){
    history.t.unshift(now - i*60000);
    history.temp.unshift(28 + Math.random()*4);
    history.hum.unshift(55 + Math.random()*10);
    history.nh3.unshift(10 + Math.random()*6);
    history.feed.unshift(60 + Math.random()*25);
  }
}
seedHistory();

/* Chart setup */
const envChart = new Chart(envChartCtx, {
  type:'line',
  data:{
    labels: history.t.map(ts => new Date(ts).toLocaleTimeString().slice(3,8)),
    datasets:[
      {label:'Temp °C', data: history.temp.slice(), borderColor:'#ff8fab', backgroundColor:'rgba(255,139,171,0.06)', fill:true, tension:0.3},
      {label:'Humidity %', data: history.hum.slice(), borderColor:'#7ee7a6', backgroundColor:'rgba(126,231,166,0.06)', fill:true, tension:0.3},
      {label:'NH3 ppm', data: history.nh3.slice(), borderColor:'#ffd166', backgroundColor:'rgba(255,209,102,0.04)', fill:true, tension:0.3}
    ]
  },
  options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true}},scales:{x:{display:false},y:{display:true}}}
});

/* Main simulation loop */
function startSimulation(){
  if (simInterval) return;
  simInterval = setInterval(()=> {
    // sensor random walk
    const lastTemp = history.temp[history.temp.length-1] || 29;
    const lastHum = history.hum[history.hum.length-1] || 60;
    const lastNh3 = history.nh3[history.nh3.length-1] || 12;
    const lastFeed = history.feed[history.feed.length-1] || 70;

    const newTemp = Math.round((lastTemp + (Math.random()*2-1)*0.6)*10)/10;
    const newHum = Math.round((lastHum + (Math.random()*2-1)*0.8)*10)/10;
    const newNh3 = Math.round(Math.max(0, lastNh3 + (Math.random()*1.6-0.8))*10)/10;
    const newFeed = Math.round(Math.max(0, lastFeed + (Math.random()*6-3))*10)/10;

    // push history
    history.t.push(Date.now());
    history.temp.push(newTemp);
    history.hum.push(newHum);
    history.nh3.push(newNh3);
    history.feed.push(newFeed);

    if (history.t.length > 40){
      history.t.shift(); history.temp.shift(); history.hum.shift(); history.nh3.shift(); history.feed.shift();
    }

    // update UI metrics
    tempVal.textContent = `${newTemp} °C`;
    humVal.textContent = `${newHum} %`;
    nh3Val.textContent = `${newNh3} ppm`;
    feedVal.textContent = `${newFeed} %`;

    // update chart
    envChart.data.labels = history.t.map(ts => new Date(ts).toLocaleTimeString().slice(3,8));
    envChart.data.datasets[0].data = history.temp.slice();
    envChart.data.datasets[1].data = history.hum.slice();
    envChart.data.datasets[2].data = history.nh3.slice();
    envChart.update();

    // simple risk calc
    let risk = Math.round(Math.max(0, (newTemp-27)*2 + (newNh3-10)*1.5 + (newHum-65)*1.2));
    risk = Math.min(99, Math.max(3, risk));
    riskScore.textContent = risk + '%';

    // auto alerts
    if (newTemp > 33 || newNh3 > 25 || newFeed < 25){
      const desc = newTemp > 33 ? `High temperature ${newTemp} °C` : newNh3 > 25 ? `High ammonia ${newNh3} ppm` : `Low feed ${newFeed}%`;
      triggerAlert(desc);
    } else {
      alertState.textContent = 'Normal';
    }

    // Simulated frame detections (replace with model inference)
    simulateDetections();

  }, 3500);
}

function stopSimulation(){
  clearInterval(simInterval); simInterval = null;
}

/* Simulate detections on overlay */
function simulateDetections(){
  // prepare overlay size
  resizeOverlay();
  ctx.clearRect(0,0,overlay.width,overlay.height);
  detections = [];
  // random chance for detections: animal clustering, sick bird, predator
  const chance = Math.random();
  if (chance < 0.45){
    const n = Math.floor(Math.random()*3);
    for (let i=0;i<n;i++){
      const w = 0.08*overlay.width + Math.random()*0.2*overlay.width;
      const h = 0.08*overlay.height + Math.random()*0.18*overlay.height;
      const x = Math.random()*(overlay.width - w - 10);
      const y = Math.random()*(overlay.height - h - 10);
      const score = Math.round(70 + Math.random()*28);
      const label = Math.random() < 0.12 ? 'Sick bird' : 'Chicken';
      const color = label === 'Sick bird' ? '#ff6b6b' : '#7ee7a6';
      detections.push({x,y,w,h,label,score,color});
    }
  }

  // draw boxes
  detections.forEach(d => {
    ctx.strokeStyle = d.color; ctx.lineWidth = Math.max(2, overlay.width/280);
    ctx.strokeRect(d.x, d.y, d.w, d.h);
    ctx.fillStyle = d.color; ctx.globalAlpha = 0.95;
    const label = `${d.label} ${d.score}%`;
    ctx.font = `${12 + Math.round(overlay.width/420)}px Poppins`;
    const textW = ctx.measureText(label).width + 12;
    ctx.fillRect(d.x, d.y - 22, textW, 20);
    ctx.fillStyle = '#041018'; ctx.fillText(label, d.x + 6, d.y - 8);
    ctx.globalAlpha = 1;
  });

  detCount.textContent = detections.length;
  if (detections.length){
    const main = detections[0];
    const message = `${main.label} detected (${main.score}%)`;
    lastAlert.textContent = message;
    pushEvent('Detection', message);
    // escalate if sick bird or many detected
    const sick = detections.find(d=>/Sick/i.test(d.label));
    if (sick || detections.length > 2) {
      triggerAlert(sick ? `Sick bird: ${sick.score}%` : `${detections.length} clustered birds`);
    }
  }
}

/* Alert handling */
function triggerAlert(message){
  pushEvent('ALERT', message);
  alertState.textContent = message;
  playBeep(1050,0.28,1.0);
  speak('Alert: ' + message);
  // small visual pulse
  const stage = document.getElementById('stage');
  stage.animate([{transform:'scale(1)'},{transform:'scale(1.012)'},{transform:'scale(1)'}],{duration:450,iterations:1});
}

/* Utility: push event to timeline */
function pushEvent(title, meta){
  const el = document.createElement('div');
  const time = new Date().toLocaleTimeString();
  el.innerHTML = `<div style="min-width:70px;color:#9fb3c8">${time}</div><div><div style="font-weight:700">${title}</div><div style="color:#9fb3c8">${meta}</div></div>`;
  timeline.prepend(el);
  if (timeline.children.length > 60) timeline.removeChild(timeline.lastChild);
}

/* Simulate a manual event */
simulateBtn.onclick = () => {
  const choices = ['Predator near coop','Sick bird detected','Feed low','Ventilation needed'];
  const pick = choices[Math.floor(Math.random()*choices.length)];
  triggerAlert(pick);
};

/* Toggle alert audio */
document.getElementById('toggleAudio').onclick = () => {
  alertSoundOn = !alertSoundOn;
  document.getElementById('toggleAudio').textContent = alertSoundOn ? 'Disable Alerts' : 'Enable Alerts';
  if (!alertSoundOn && window.speechSynthesis) window.speechSynthesis.cancel();
};

/* Quick action handlers (mock) */
document.getElementById('ventilateBtn').onclick = () => {
  pushEvent('Action', 'Ventilation triggered (mock)');
  speak('Ventilation activated');
};
document.getElementById('feedBtn').onclick = () => {
  pushEvent('Action', 'Feed top-up scheduled (mock)');
  speak('Feed top up scheduled');
};
document.getElementById('notifyBtn').onclick = () => {
  pushEvent('Action', 'Notification sent to farm manager (mock)');
  speak('Notification sent to farm manager');
};

/* Keyboard shortcuts */
window.addEventListener('keydown', (e)=>{
  if (e.key==='s') startBtn.click();
  if (e.key==='p') stopBtn.click();
  if (e.key==='m') simulateBtn.click();
});

/* Clean up */
window.addEventListener('beforeunload', ()=>{
  try { if (stream) stream.getTracks().forEach(t=>t.stop()); } catch(e){}
  if (window.speechSynthesis) window.speechSynthesis.cancel();
});

/* init small seed */
pushEvent('System', 'PoliAI initialized (mock)');
</script>
</body>
</html>